{% extends "base.html" %}

{% block head %}
  <!--CSS file (default YUI Sam Skin) -->
  <link rel="stylesheet" type="text/css" href="{{ MEDIA_URL }}yui/calendar/assets/skins/sam/calendar.css" media="screen" >
  <!-- Custom CSS -->
  <link rel="stylesheet" type="text/css" href="{{MEDIA_URL}}css/div_list.css" media="screen"/>
  <link rel="stylesheet" type="text/css" href="{{ MEDIA_URL }}css/yui_custom.css" media="screen" >
  <link rel="stylesheet" type="text/css" href="{{ MEDIA_URL }}css/schedule.css" media="screen" >
  <!-- Dependencies -->
  <script type="text/javascript" src="{{ MEDIA_URL }}yui/yahoo-dom-event/yahoo-dom-event.js"></script>
  <script type="text/javascript" src="{{ MEDIA_URL }}yui/calendar/calendar-min.js"></script>
  <script type="text/javascript" src="{{ MEDIA_URL }}yui/connection/connection-min.js"></script>
  <script type="text/javascript" src="{{ MEDIA_URL }}yui/datasource/datasource-min.js"></script> 
  <script type="text/javascript" src="{{ MEDIA_URL }}yui/autocomplete/autocomplete-min.js"></script>
  <script type="text/javascript" src="{{ MEDIA_URL }}yui/json/json-min.js"></script>
  <!-- Custom JS -->
  <script type="text/javascript" src="{{ MEDIA_URL }}js/scheduling.js"></script>
  {# <script type="text/javascript" src="{{ MEDIA_URL }}js/cal_selector.js"></script> #}

  <script type="text/javascript">
    var jsonString = '{{ cal_json|safe }}';
    try {
        var days = YAHOO.lang.JSON.parse(jsonString);
    }
    catch (e) {
        alert("unable to load calendar data");
    }


    function selectDate() {
      YAHOO.schedule.cal1.cfg.setProperty("pagedate", "{{ date|date:"m/Y" }}", false); 
      YAHOO.schedule.cal1.cfg.setProperty("selected", "{{ date|date:"m/d/Y" }}", false); 
      YAHOO.schedule.cal1.render();
    }
    function taskClick(e, taskDisplay) {
      var taskEdit = YAHOO.util.Dom.getNextSibling(taskDisplay);
      YAHOO.util.Dom.addClass(taskDisplay, 'hidden');
      YAHOO.util.Dom.removeClass(taskEdit, 'hidden');
    }
    function taskClickAssign() {
      var taskDisplays = YAHOO.util.Dom.getElementsByClassName('task-display', 'tr');
      for (i=0; i<taskDisplays.length; i++) {
        var taskDisplay = taskDisplays[i];
        YAHOO.util.Event.on(taskDisplay, 'click', taskClick, taskDisplay);
      }
    }
    YAHOO.util.Event.onDOMReady(selectDate);
    YAHOO.util.Event.onDOMReady(taskClickAssign);
    function taskAdd() {
      YAHOO.util.Dom.removeClass('task-add', 'hidden');
      document.forms.add.time_1.select();
    }
  </script>
  <!-- Calendar styles -->
  <style type="text/css">
    {% for task in tasks %}
      .yui-skin-sam {{ task.time|date:".\yY .\mn .\dj" }} {text-decoration: underline;}
    {% endfor %}
  </style> 
{% endblock head %}

{% block content %}
  <div id="left-column">
    {% include "scheduling/snippets/page_menu.html" %}
    <div id="primary-content-wrapper">
      <form onsubmit="taskAdd(); return false">
        <div class="add-button">
          <input type="submit" value="Add a task" />
        </div>
      </form>
      <h2>
        <a href="{% url scheduling-schedule previous_date|date:"Y-m-d" %}">&larr;</a> 
        {{ date|date:"l, F jS, Y" }} 
        <a href="{% url scheduling-schedule next_date|date:"Y-m-d" %}">&rarr;</a>
      </h2>
      <div id="task-add"{% if not add_form.errors %} class="hidden"{% endif %}>
        <form class="standard" method="post" name="add">
          <div id="add_form_chunk">
            <label for="id_time_1">Time:</label> {{ add_form.time }}
            <label for="id_hours">Hours:</label> {{ add_form.hours }}
            <span class="errors">{{ add_form.time.errors|join:" " }} {{ add_form.hours.errors|join:" " }}</span>
          </div>
          <div id="add_form_chunk">
            <label for="id_frequency">Frequency:</label> {{ add_form.frequency }}
            <label for="id_interval">Interval:</label> {{ add_form.interval }}
            <span class="errors">{{ add_form.frequency.errors|join:" " }} {{ add_form.interval.errors|join:" " }}</span>
          </div>
          <div id="add_form_chunk">
            <label for="id_job">Job:</label> {{ add_form.job }}
            <span class="errors">{{ add_form.job.errors|join:" " }}</span>
          </div>
          <label>Workers (members and accounts):</label>
          {{ add_form_workers.management_form }}
          <ul id="worker_list">
          {% for worker_form in add_form_workers.forms %}
            <li>{{ worker_form.member }} {{ worker_form.account }}</li>
          {% endfor %}
            <li id="worker-writeroot" class="add" style="text-align:left">
              <a class="add" href="" onclick="addForm('worker', '{% url scheduling-worker-form %}'); return false;" id="worker-add">Add</a>
            </li>
          </ul>
          <p style="margin:30px 0 0 0"><input type="submit" value="Save" /></p>
        </form>
      </div>
      <table class="data" id="daily-view">
        <tr>
          <th>Time</th>
          <th>Job</th>
          <th>Workers</th>
        </tr>
        {% for group in task_groups %}
        <tr class="task-display {% cycle "odd" "even" %}">
          <td class="time">
          {% if group.proto.deadline %}
            {{ group.proto.time|date:"P" }} deadline for {{ group.proto.hours }} hour task
          {% else %}
            {{ group.proto.time|date:"P" }} &ndash; {{ group.proto.get_end|date:"P" }}
          {% endif %}
            <br />
          {% if group.proto.frequency and group.proto.interval %}
            (recurs every {{ group.proto.get_recurrence_display }})
          {% endif %}
          </td>
          <td>{{ group.proto.job }}</td>
          <td>
            <ul>
            {% for task in group.tasks %}
              {% if task.member and task.account %}
              <li>{{ task.member }}, {{ task.account }}</li>
              {% else %}
              <li class="unassigned">Unassigned</li>
              {% endif %}
            {% endfor %}
            </ul>
          </td>
        </tr>
        <tr class="task-edit hidden">
          <form>
            <td colspan="3">
              {{ group.form.time }}<br />
              {{ group.form.frequency }} {{ group.form.interval }}
              {{ group.form.job }}
              <ul>
              {% for worker_form in group.worker_forms %}
                <li>{{ worker_form.member }} {{ worker_form.account }}</li>
              {% endfor %}
              </ul>
              <input type="submit" value="Save" />
            </td>
          </form>
        </tr>
        {% endfor %}
      </table>
    </div>
  </div>
  <div id="right-column">
    <h3 id="right-column-heading">Calendar</h3>
    <div id="cal1Container"></div>
      {# <div id="task-list"></div> #}
      {# <div id="task-form"> </div> #}
  </div>
{% endblock content %}
